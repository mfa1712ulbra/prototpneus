/**
 * @fileOverview Firestore Security Rules for the PrototPneus application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all data. Each user has complete control over their own data (vehicles, tires, and movements), while preventing access to other users' data.
 *
 * Data Structure:
 * The data is organized hierarchically under `/usuarios/{usuarioId}`, with subcollections for vehicles, tires, and movement history:
 * - /usuarios/{usuarioId}
 * - /usuarios/{usuarioId}/veiculos/{veiculoId}
 * - /usuarios/{usuarioId}/veiculos/{veiculoId}/pneus/{pneuId}
 * - /usuarios/{usuarioId}/veiculos/{veiculoId}/pneus/{pneuId}/movimentacoes/{movimentacaoId}
 * - /usuarios/{usuarioId}/motoristas/{motoristaId}
 * - /usuarios/{usuarioId}/tiposPneu/{tipoPneuId}
 *
 * Key Security Decisions:
 * - All data is private and accessible only to the owning user.
 * - Listing other users' data is disallowed.
 * - Rules are structured to avoid costly `get()` operations by leveraging path-based ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    /**
     * @description Controls access to user profile data.
     * @principle Enforces document ownership; only the user can manage their own profile.
     */
    match /usuarios/{usuarioId} {
      allow get, update, delete: if isOwner(usuarioId);
      allow create: if isOwner(usuarioId) && request.resource.data.id == usuarioId;
      // Disallow listing all users
      allow list: if false;
    }

    /**
     * @description Controls access to vehicle data for a specific user.
     * @principle Enforces document ownership; only the user can manage their own vehicles.
     */
    match /usuarios/{usuarioId}/veiculos/{veiculoId} {
      allow read, write: if isOwner(usuarioId);
    }

    /**
     * @description Controls access to tire data for a specific vehicle.
     * @principle Enforces document ownership; only the user can manage tires on their own vehicles.
     */
    match /usuarios/{usuarioId}/veiculos/{veiculoId}/pneus/{pneuId} {
      allow read, write: if isOwner(usuarioId);
    }
    
    /**
     * @description Controls access to tire movement data for a specific tire.
     * @principle Enforces document ownership; only the user can manage movements for their own tires.
     */
    match /usuarios/{usuarioId}/veiculos/{veiculoId}/pneus/{pneuId}/movimentacoes/{movimentacaoId} {
       allow read, write: if isOwner(usuarioId);
    }

    /**
     * @description Controls access to driver data for a specific user.
     * @principle Enforces document ownership; only the user can manage their own drivers.
     */
    match /usuarios/{usuarioId}/motoristas/{motoristaId} {
      allow read, write: if isOwner(usuarioId);
    }

    /**
     * @description Controls access to tire type data for a specific user.
     * @principle Enforces document ownership; only the user can manage their own tire types.
     */
    match /usuarios/{usuarioId}/tiposPneu/{tipoPneuId} {
      allow read, write: if isOwner(usuarioId);
    }
  }
}
